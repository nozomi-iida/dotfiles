---
allowed-tools:
  - Read
  - Grep
  - Glob
  - Bash
  - AskUserQuestion
description: git diffとコミット履歴からPR本文を自動生成し、不足情報は対話で補完してドラフトPRを作成する。「PR作って」「PRを作成して」と言われた時に使用。
targets:
  - "*"
---

# PR作成コマンド

## 概要

現在のブランチのgit diffとコミット履歴を解析し、`.github/pull_request_template.md` をベースにPR本文を自動生成する。不足情報は対話で補完する。

## 引数フォーマット

```
$ARGUMENTS = [--base ブランチ名] [--title PRタイトル] [--ticket チケットID] [--no-draft] [その他の指示]
```

### オプション引数

- `--base <branch>`: マージ先ブランチ（デフォルト: develop）
- `--title <title>`: PRタイトル（指定がなければコミット履歴から自動生成）
- `--ticket <id>`: チケットID（例: HR-6195）
- `--no-draft`: ドラフトではなく通常PRとして作成
- その他: ユーザーが追加で指定した指示

## 実行手順

### Step 1: 引数の解析

`$ARGUMENTS` から以下を抽出:

- `--base` オプション（指定がなければ `develop`）
- `--title` オプション（指定がなければ後でStep 3で自動生成）
- `--ticket` オプション（指定がなければ後でStep 4で対話補完）
- `--no-draft` フラグ（指定がなければドラフトPRとして作成）
- その他のオプション・指示

### Step 2: ブランチ状態の確認

#### 2-1: ベースブランチの検証

```bash
git rev-parse --verify origin/{{base}} 2>/dev/null
```

ブランチが存在しない場合はエラーを表示して終了。

#### 2-2: ブランチ差分の確認

```bash
# 変更ファイル一覧
git diff origin/{{base}}...HEAD --name-only

# 差分の詳細（ステータス付き）
git diff origin/{{base}}...HEAD --stat

# コミット履歴
git log origin/{{base}}..HEAD --oneline --no-merges
```

#### 2-3: 差分がない場合の処理

ブランチ差分がない場合、ステージングされたファイルを確認:

```bash
git diff --cached --name-only
```

- **ステージングファイルがある場合**: ユーザーにコミット・プッシュするか確認してから進める
- **差分もステージングもない場合**: 「PRを作成する変更がありません」と表示して終了

### Step 3: 差分の解析とPR内容の自動生成

#### 3-1: コミット履歴の解析

コミットメッセージから以下を推定:

- 変更の種類（feat / fix / refactor / test / docs など）
- 変更の概要

#### 3-2: diffの解析

`git diff origin/{{base}}...HEAD` の内容を読み、以下を把握:

- 主な変更内容（新規ファイル、修正ファイル、削除ファイル）
- 変更の技術的な要約

#### 3-3: PRタイトルの生成（--titleが未指定の場合）

以下の優先順で決定:

1. ブランチ名からチケットIDと機能名を推定（例: `feature/HR-1234-add-login` → `feat: ログイン機能の追加`）
2. コミットメッセージの要約
3. 推定が困難な場合はユーザーに確認

PRタイトルのフォーマット:
- `feat:`, `fix:`, `refactor:` などのprefixを付与
- 日本語で簡潔に記述（70文字以内）

### Step 4: 不足情報の対話補完

以下の情報について、引数やブランチ名から取得できなかったものをまとめて確認する。
**質問は1回にまとめること（何度も聞かない）。**

確認する項目:

1. **チケットID**: ブランチ名から推定できない場合に確認（例: `HR-6195`）
2. **PRタイトル**: Step 3で自動生成した案を提示し、修正が必要か確認
3. **この変更で実現すること**: diffから推定した概要を提示し、補足が必要か確認
4. **実装方針・背景**: 特筆すべき技術的判断があれば入力を促す

**diffから十分に推定できる情報は確認を省略してよい。**

### Step 5: PR本文の生成

`.github/pull_request_template.md` を読み込み、以下のルールで埋める:

#### チケット情報

```markdown
### チケット情報

- チケット: {{TICKET}}
  - {{チケットID（取得できた場合）}}
- Figma: {{FIGMA_URL}}
- 機能設計書: {{FUNCTIONAL_SPECIFICATION}}
```

**重要**: `{{TICKET}}`, `{{FIGMA_URL}}`, `{{FUNCTIONAL_SPECIFICATION}}` プレースホルダーは絶対に変更・置換しないこと。チケットIDが分かった場合は、プレースホルダーの下の行に追記する。

#### この変更で実現すること

diffとコミット履歴から自動生成した内容 + ユーザーからの補足を記載。

#### 実装方針・背景

技術的な判断ポイントがあれば記載。ない場合は `-` のまま。

#### 変更内容の詳細

diffから変更ファイル一覧をテーブル形式で記載:

```markdown
| ファイル | 変更種別 | 変更内容 |
| :--- | :---: | :--- |
| `path/to/file.ts` | 追加 | [変更内容の説明] |
| `path/to/file2.ts` | 修正 | [変更内容の説明] |
```

変更種別は `追加` / `修正` / `削除` / `リネーム` を使う。

#### 動作確認項目

テンプレートのチェックリストはそのまま残す（ユーザーが手動で確認後にチェックする想定）。

#### 影響範囲

変更ファイルから影響が及ぶ機能・画面を推定して記載。

#### スクリーンショット / 画面収録 / レビュー前チェックリスト / 備考

テンプレートのままにしておく（ユーザーがPR作成後に追加）。

### Step 6: プッシュとPR作成

#### 6-1: リモートへのプッシュ

現在のブランチがリモートに存在するか確認し、必要であればプッシュ:

```bash
git ls-remote --heads origin $(git branch --show-current)
```

リモートに存在しない、またはローカルが進んでいる場合:

```bash
git push -u origin HEAD
```

#### 6-2: PR作成

```bash
gh pr create \
  --title "{{PRタイトル}}" \
  --body "$(cat <<'EOF'
{{PR本文}}
EOF
)" \
  --base {{base}} \
  {{--draft フラグ（--no-draftが指定されていなければ --draft を付与）}}
```

### Step 7: 結果の表示

- 作成されたPRのURLを表示
- ドラフト/通常PRのどちらで作成されたかを通知
- 「PR本文を確認し、スクリーンショットやチケットURLなど不足情報を追記してください」と案内

## 重要な注意事項

1. **プレースホルダーの保護**: `{{TICKET}}`, `{{FIGMA_URL}}`, `{{FUNCTIONAL_SPECIFICATION}}` は絶対に変更しない
2. **ドラフトPR**: デフォルトはドラフトとして作成（`--no-draft` で上書き可能）
3. **ユーザー指示優先**: ユーザーが追加で指定した指示は最優先で適用
4. **質問は最小限**: diffから推定できる情報は確認せず、不足情報のみまとめて1回で聞く
5. **日本語**: PRタイトル・本文は日本語で記述

## 使用例

```bash
# 基本的な使用（diffから自動生成）
/create-pr

# ベースブランチとチケットを指定
/create-pr --base main --ticket HR-6195

# タイトルを指定して通常PRとして作成
/create-pr --title "fix: isNew判定ロジックの修正" --no-draft

# 追加指示付き
/create-pr --ticket HR-6195 スクリーンショットセクションは削除して
```

---

<user_requirement>
以下の引数でPRを作成してください:
$ARGUMENTS
</user_requirement>
